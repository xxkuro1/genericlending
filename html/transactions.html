<!DOCTYPE html>

<html>



	<head>
	<link href="../css/style.css" rel="stylesheet" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"> </script>
	<!-- Compiled and minified CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
	<!-- Compiled and minified JavaScript -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <link href="../css/skeleton.css" rel="stylesheet" type="text/css">
        <link href="../css/normalize.css" rel="stylesheet" type="text/css">
	</head>
	<style>
        td, th {
            border: 1px solid #dddddd;
            text-align: center;
            padding: 8px;

        }


        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

	</style>

	<body>

		 <iframe id="header-iframe" scrolling="no" src="headerloan.html"></iframe>
	<div align="center" class="search">

    	

		<br>
		<form>
			<input class="inputsearch" id="inputsearch" name="search" onkeyup="filterTable()" type="text"><br>

		</form>


	</div>

				<div class="table">

					<div align="center" class="somemodal">
						<!--- MODAL BODY -->
						<div class="modal" id="modal1">
							<div class="modal-content">

									<label>Transaction ID </label>
									<input class="inputfield u-full-width" id="tid" placeholder="Transaction ID" readonly type="number">
									<label>Current Day + Penalty </label>
									<label id="penaltydate">Date goes here</label>
									<input class="inputfield u-full-width" id="penalty" placeholder="Date and Penalty" readonly type="number">
									<label>First Name: </label>
									<input class="inputfield u-full-width" id="fname" placeholder="First Name" type="text"><br>
									<label>Last Name: </label>
									<input class="inputfield u-full-width" id="lname"  placeholder="Last Name" type="text">
									<label>Address: </label>
									<textarea class="inputfield u-full-width" id="address" placeholder="Address"
											  type="text"></textarea><br><br>

								<label>Term of Payment (per year) </label>
								<select id="termofpayment" class="payment browser-default inputfield" disabled>
									<option value=1>1</option>
									<option value=2>2</option>
									<option value=3>3</option>
									<option value=4>4</option>
									<option value=5>5</option>
									<option value=6>6</option>
									<option value=7>7</option>
									<option value=8>8</option>
									<option value=9>9</option>
									<option value=10>10</option>
								</select><br>
								<label>Loan Interest (percent) </label>
								<input class="inputfield u-full-width" id="loaninterest" placeholder="10" readonly type="number" value="10">
								<label>Current Amount</label>
								<input class="inputfield u-full-width" id="currentamount" placeholder="Amount" type="number" >
								<label>Total paid with Interest (with Interest)</label>
								<input class="inputfield" id="totalpaid" readonly type="number">

								<label>Monthly Pay(With Interest)</label>
								<input class="inputfield" id="monthlypaid" readonly type="number">
								<br><br>
								<label>Due Date</label>
								<input class="inputfield" id="duedate" readonly type="date"><br><br>
								<input class="modal-trigger button button-primary btnAdd" data-target="modal1" id="btnEdit" onclick="editData($('#tid').val())" type="button"  value="Add Transactions">
							</div>
							<div class="modal-footer">
								<a class="modal-close waves-effect waves-green btn-flat" href="#!">Save</a>
								<a class="modal-close waves-effect waves-red btn-flat" href="#!">Cancel</a>
							</div>
						</div>
					</div>

                    <table id="tableID" width="50%">
                        <thead>
                        <tr  class="thcolor">
                            <th>Transaction ID</th>
                            <th>FirstName</th>
                            <th>LastName</th>
                            <th>Address</th>
                            <th>Actions</th>
                        </tr>
                        <tbody id="tablebody">

                        </tbody>
                        </thead>

                    </table>
			</div>
	</body>
    <script type="text/javascript">
		let globalDue;
        $(document).ready(function () {
            $.ajax({
                url: "../php/view.php",
                type: "POST",
                cache: false,
                success: function (response) {
                    //alert(response);
                    $("#tablebody").html(response);
                }
            });
			$(document).ready(function(){
				$('.modal').modal();
				//getcurrentDate();
				//getpenaltyfee();
			});
        });

		function getcurrentDate(oldate){
			let today = new Date();
			let date = (today.getMonth()+1)+"-"+today.getDate()+"-"+today.getFullYear();
			let penaltydate = new Date(oldate);
			let penaltylabel = document.getElementById("penaltydate");
			let penaltybox = document.getElementById("penalty");

			penaltybox.value = Number((penaltydate.getTime() - today.getTime())/31536000000).toFixed(0);

			penaltylabel.innerHTML = (penaltydate.getMonth()+1)+"-"+penaltydate.getDate()+"-"+penaltydate.getFullYear() +" and "+ date;

			//alert(date);
		}



        function viewData(id, type) {
			getcurrentDate();
            $.ajax({
                url: "../php/viewdata.php",
                method: "POST",
				dataType:"json",
                data: {
                    key: "view",
                    id: id
                },
                cache: false,
                success: function (response) {
                	getcurrentDate(response.dd);
					if(type == "view"){
						$("#tid").val(response.tid);
						$("#fname").val(response.fname);
						$("#lname").val(response.lname);
						$("#address").val(response.address);
						$("#currentamount").val(response.amount);
						$("#termofpayment").val(response.top);
						$("#totalpaid").val(response.tp);
						$("#monthlypaid").val(response.mp);
						$("#duedate").val(response.dd);

					}

                }
            });
        }
		function editData(id){
			//alert("EDIT row "+id);

			$.ajax({
				url: "../php/edit.php",
				method: "POST",
				dataType: "text",
				data:{
					key: "edit",
					id: id
				},
				cache: false,
				success:function (response) {
					alert(response);
				}

			});
		}

        function deleteData(id) {
            let inputsearch = $("#inputsearch");
            inputsearch.val();
            $.ajax({
                url: "../php/delete.php",
                type: "POST",
                data: {
                    key: "delete",
                    id: id
                },
                cache: false,
                success: function (response) {
                    alert(response);
                    $("#transaction_id_" + id).parent().remove();
                }
            });

        }
		

        //Data Table alternative (requested by sir tan)
        function filterTable() {
            // ES declarations
            let input, filter, table, tr, td, i, txtval;
            input = document.getElementById("inputsearch");
            filter = input.value.toUpperCase();
            table = document.getElementById("tablebody");
            tr = table.getElementsByTagName("tr");

            //loop through the rows
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[1];
                if (td) {
                    txtval = td.textContent || td.innerText;
                    if (txtval.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }



		let amountevent = document.getElementById('currentamount');
		let topevent = document.getElementById("termofpayment");

		amountevent.addEventListener('input', (event) => {
			let amount = Number(document.getElementById("currentamount").value);
			let interest = Number(document.getElementById("loaninterest").value);
			let year = Number(document.getElementById("termofpayment").value);
			let interest1 = (Number(amount)*Number(interest)*Number(year))/100;

			let total = amount + interest1;
			let emi = total/(year*12);
			document.getElementById("totalpaid").value = total;
			document.getElementById("monthlypaid").value = emi;
		});

		topevent.addEventListener('change', (event) => {
			let amount = Number(document.getElementById("currentamount").value);
			let interest = Number(document.getElementById("loaninterest").value);
			let year = Number(document.getElementById("termofpayment").value);
			let interest1 = (Number(amount)*Number(interest)*Number(year))/100;

			let total = amount + interest1;
			let emi = total/(year*12);
			document.getElementById("totalpaid").value = total;
			document.getElementById("monthlypaid").value = emi;
		});




    </script>
	</html>